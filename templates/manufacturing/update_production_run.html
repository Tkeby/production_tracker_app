{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="max-w-6xl mx-auto">
        <!-- Breadcrumbs -->
        <div class="breadcrumbs text-sm mb-6">
            <ul>
                <li><a href="{% url 'manufacturing:dashboard' %}">Dashboard</a></li>
                <li><a href="{% url 'manufacturing:production_run_detail' object.pk %}">{{ object.production_batch_number }}</a></li>
                <li>Edit</li>
            </ul>
        </div>

        <div class="card bg-base-100 shadow-xl">
            <div class="card-body">
                <div class="flex items-center gap-4 mb-6">
                    <div class="avatar placeholder">
                        <div class="bg-primary text-primary-content rounded-full w-12">
                            <span class="text-xl">üìù</span>
                        </div>
                    </div>
                    <div>
                        <h1 class="card-title text-3xl">Update Production Run</h1>
                        <div class="flex gap-2 items-center mt-2">
                            <div class="badge badge-primary badge-lg">{{ object.production_batch_number }}</div>
                            <div class="badge badge-outline">{{ object.product.name }}</div>
                        </div>
                    </div>
                </div>
            
                <form method="post" class="space-y-6">
                    {% csrf_token %}
                    
                    <div class="tabs tabs-boxed mb-6">
                        <a class="tab tab-active">Basic Info</a>
                        <a class="tab">Production Data</a>
                        <a class="tab">Timing</a>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Basic Information -->
                        <div class="form-control">
                            <label class="label" for="{{ form.order_number.id_for_label }}">
                                <span class="label-text">Manufacturing Order</span>
                            </label>
                            {{ form.order_number }}
                            {% if form.order_number.errors %}
                                <label class="label">
                                    <span class="label-text-alt text-error">{{ form.order_number.errors.0 }}</span>
                                </label>
                            {% endif %}
                            <div id="product-info"></div>
                        </div>
                        
                        <div class="form-control">
                            <label class="label" for="{{ form.production_batch_number.id_for_label }}">
                                <span class="label-text">Production Batch Number</span>
                            </label>
                            {{ form.production_batch_number }}
                            {% if form.production_batch_number.errors %}
                                <label class="label">
                                    <span class="label-text-alt text-error">{{ form.production_batch_number.errors.0 }}</span>
                                </label>
                            {% endif %}
                        </div>
                        
                        <div class="form-control">
                            <label class="label" for="{{ form.date.id_for_label }}">
                                <span class="label-text">Production Date</span>
                            </label>
                            {{ form.date }}
                            {% if form.date.errors %}
                                <label class="label">
                                    <span class="label-text-alt text-error">{{ form.date.errors.0 }}</span>
                                </label>
                            {% endif %}
                        </div>
                        
                        <div class="form-control">
                            <label class="label" for="{{ form.production_line.id_for_label }}">
                                <span class="label-text">Production Line</span>
                            </label>
                            {{ form.production_line }}
                            {% if form.production_line.errors %}
                                <label class="label">
                                    <span class="label-text-alt text-error">{{ form.production_line.errors.0 }}</span>
                                </label>
                            {% endif %}
                        </div>
                        
                        <!-- Product Information -->
                        <div class="form-control">
                            <label class="label" for="{{ form.product.id_for_label }}">
                                <span class="label-text">Product</span>
                            </label>
                            <div id="product-options">
                                {{ form.product }}
                            </div>
                            {% if form.product.errors %}
                                <label class="label">
                                    <span class="label-text-alt text-error">{{ form.product.errors.0 }}</span>
                                </label>
                            {% endif %}
                        </div>
                        
                        <div class="form-control">
                            <label class="label" for="{{ form.package_size.id_for_label }}">
                                <span class="label-text">Package Size</span>
                            </label>
                            <div id="package-options">
                                {{ form.package_size }}
                            </div>
                            {% if form.package_size.errors %}
                                <label class="label">
                                    <span class="label-text-alt text-error">{{ form.package_size.errors.0 }}</span>
                                </label>
                            {% endif %}
                        </div>
                        
                        <!-- Shift & Timing -->
                        <div class="form-control">
                            <label class="label" for="{{ form.shift.id_for_label }}">
                                <span class="label-text">Shift</span>
                            </label>
                            {{ form.shift }}
                            {% if form.shift.errors %}
                                <label class="label">
                                    <span class="label-text-alt text-error">{{ form.shift.errors.0 }}</span>
                                </label>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Production Timing Section -->
                    <div class="divider divider-primary">Production Timing</div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="form-control">
                            <label class="label" for="{{ form.production_start.id_for_label }}">
                                <span class="label-text">Production Start</span>
                            </label>
                            {{ form.production_start }}
                            {% if form.production_start.errors %}
                                <label class="label">
                                    <span class="label-text-alt text-error">{{ form.production_start.errors.0 }}</span>
                                </label>
                            {% endif %}
                        </div>
                        
                        <div class="form-control">
                            <label class="label" for="{{ form.production_end.id_for_label }}">
                                <span class="label-text">Production End</span>
                            </label>
                            {{ form.production_end }}
                            {% if form.production_end.errors %}
                                <label class="label">
                                    <span class="label-text-alt text-error">{{ form.production_end.errors.0 }}</span>
                                </label>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Production Data Section -->
                    <div class="divider divider-secondary">Production Data</div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="form-control">
                            <label class="label" for="{{ form.filler_output.id_for_label }}">
                                <span class="label-text">Filler Output</span>
                            </label>
                            {{ form.filler_output }}
                            {% if form.filler_output.errors %}
                                <label class="label">
                                    <span class="label-text-alt text-error">{{ form.filler_output.errors.0 }}</span>
                                </label>
                            {% else %}
                                <label class="label">
                                    <span class="label-text-alt">Bottles per hour</span>
                                </label>
                            {% endif %}
                        </div>
                        
                        <div class="form-control">
                            <label class="label" for="{{ form.final_syrup_volume.id_for_label }}">
                                <span class="label-text">Final Syrup Volume</span>
                            </label>
                            <div class="join">
                                {{ form.final_syrup_volume }}
                                <span class="btn btn-outline join-item">L</span>
                            </div>
                            {% if form.final_syrup_volume.errors %}
                                <label class="label">
                                    <span class="label-text-alt text-error">{{ form.final_syrup_volume.errors.0 }}</span>
                                </label>
                            {% endif %}
                        </div>
                        
                        <div class="form-control">
                            <label class="label" for="{{ form.mixing_ratio.id_for_label }}">
                                <span class="label-text">Mixing Ratio</span>
                            </label>
                            {{ form.mixing_ratio }}
                            {% if form.mixing_ratio.errors %}
                                <label class="label">
                                    <span class="label-text-alt text-error">{{ form.mixing_ratio.errors.0 }}</span>
                                </label>
                            {% endif %}
                        </div>
                        
                        <div class="form-control">
                            <label class="label" for="{{ form.good_products_pack.id_for_label }}">
                                <span class="label-text">Good Products</span>
                            </label>
                            <div class="join">
                                {{ form.good_products_pack }}
                                <span class="btn btn-outline join-item">Packs</span>
                            </div>
                            {% if form.good_products_pack.errors %}
                                <label class="label">
                                    <span class="label-text-alt text-error">{{ form.good_products_pack.errors.0 }}</span>
                                </label>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Packaging Materials Section -->
                    <div class="collapse collapse-arrow bg-base-100 border border-base-300 rounded-lg shadow-sm mt-4">
                        <input type="checkbox" name="packaging-accordion" checked>
                        <div class="collapse-title text-xl font-medium">
                            <div class="flex items-center gap-3">
                                <svg class="w-6 h-6 text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                                </svg>
                                <span>Packaging Materials</span>
                                <div class="badge badge-info badge-sm">Required</div>
                            </div>
                        </div>
                        <div class="collapse-content">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 pt-4">
                                <div class="form-control">
                                    <label class="label" for="{{ packaging_form.qty_preform_used.id_for_label }}">
                                        <span class="label-text">Preforms Used</span>
                                        <span class="label-text-alt text-error">*</span>
                                    </label>
                                    {{ packaging_form.qty_preform_used }}
                                    {% if packaging_form.qty_preform_used.errors %}
                                        <label class="label">
                                            <span class="label-text-alt text-error">{{ packaging_form.qty_preform_used.errors.0 }}</span>
                                        </label>
                                    {% endif %}
                                </div>

                                <div class="form-control">
                                    <label class="label" for="{{ packaging_form.qty_cap_used.id_for_label }}">
                                        <span class="label-text">Caps Used</span>
                                        <span class="label-text-alt text-error">*</span>
                                    </label>
                                    {{ packaging_form.qty_cap_used }}
                                    {% if packaging_form.qty_cap_used.errors %}
                                        <label class="label">
                                            <span class="label-text-alt text-error">{{ packaging_form.qty_cap_used.errors.0 }}</span>
                                        </label>
                                    {% endif %}
                                </div>

                                <div class="form-control">
                                    <label class="label" for="{{ packaging_form.qty_product_reject.id_for_label }}">
                                        <span class="label-text">Product Rejects</span>
                                        <span class="label-text-alt text-error">*</span>
                                    </label>
                                    {{ packaging_form.qty_product_reject }}
                                    {% if packaging_form.qty_product_reject.errors %}
                                        <label class="label">
                                            <span class="label-text-alt text-error">{{ packaging_form.qty_product_reject.errors.0 }}</span>
                                        </label>
                                    {% endif %}
                                </div>

                                <div class="form-control">
                                    <label class="label" for="{{ packaging_form.qty_preform_reject.id_for_label }}">
                                        <span class="label-text">Preform Rejects</span>
                                        <span class="label-text-alt text-error">*</span>
                                    </label>
                                    {{ packaging_form.qty_preform_reject }}
                                    {% if packaging_form.qty_preform_reject.errors %}
                                        <label class="label">
                                            <span class="label-text-alt text-error">{{ packaging_form.qty_preform_reject.errors.0 }}</span>
                                        </label>
                                    {% endif %}
                                </div>

                                <div class="form-control">
                                    <label class="label" for="{{ packaging_form.qty_bottle_reject.id_for_label }}">
                                        <span class="label-text">Bottle Rejects</span>
                                        <span class="label-text-alt text-error">*</span>
                                    </label>
                                    {{ packaging_form.qty_bottle_reject }}
                                    {% if packaging_form.qty_bottle_reject.errors %}
                                        <label class="label">
                                            <span class="label-text-alt text-error">{{ packaging_form.qty_bottle_reject.errors.0 }}</span>
                                        </label>
                                    {% endif %}
                                </div>

                                <div class="form-control">
                                    <label class="label" for="{{ packaging_form.qty_cap_reject.id_for_label }}">
                                        <span class="label-text">Cap Rejects</span>
                                        <span class="label-text-alt text-error">*</span>
                                    </label>
                                    {{ packaging_form.qty_cap_reject }}
                                    {% if packaging_form.qty_cap_reject.errors %}
                                        <label class="label">
                                            <span class="label-text-alt text-error">{{ packaging_form.qty_cap_reject.errors.0 }}</span>
                                        </label>
                                    {% endif %}
                                </div>

                                <div class="form-control">
                                    <label class="label" for="{{ packaging_form.label_reject_g.id_for_label }}">
                                        <span class="label-text">Label Reject</span>
                                        <span class="label-text-alt text-error">*</span>
                                    </label>
                                    <div class="join">
                                        {{ packaging_form.label_reject_g }}
                                        <span class="btn btn-outline join-item">g</span>
                                    </div>
                                    {% if packaging_form.label_reject_g.errors %}
                                        <label class="label">
                                            <span class="label-text-alt text-error">{{ packaging_form.label_reject_g.errors.0 }}</span>
                                        </label>
                                    {% endif %}
                                </div>

                                <div class="form-control">
                                    <label class="label" for="{{ packaging_form.shrink_wrap_kg.id_for_label }}">
                                        <span class="label-text">Shrink Wrap</span>
                                        <span class="label-text-alt text-error">*</span>
                                    </label>
                                    <div class="join">
                                        {{ packaging_form.shrink_wrap_kg }}
                                        <span class="btn btn-outline join-item">kg</span>
                                    </div>
                                    {% if packaging_form.shrink_wrap_kg.errors %}
                                        <label class="label">
                                            <span class="label-text-alt text-error">{{ packaging_form.shrink_wrap_kg.errors.0 }}</span>
                                        </label>
                                    {% endif %}
                                </div>

                                <div class="form-control">
                                    <label class="label" for="{{ packaging_form.stretch_wrap_g.id_for_label }}">
                                        <span class="label-text">Stretch Wrap</span>
                                        <span class="label-text-alt text-error">*</span>
                                    </label>
                                    <div class="join">
                                        {{ packaging_form.stretch_wrap_g }}
                                        <span class="btn btn-outline join-item">g</span>
                                    </div>
                                    {% if packaging_form.stretch_wrap_g.errors %}
                                        <label class="label">
                                            <span class="label-text-alt text-error">{{ packaging_form.stretch_wrap_g.errors.0 }}</span>
                                        </label>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Utility Consumption Section -->
                    <div class="collapse collapse-arrow bg-base-100 border border-base-300 rounded-lg shadow-sm mt-4">
                        <input type="checkbox" name="utility-accordion" checked>
                        <div class="collapse-title text-xl font-medium">
                            <div class="flex items-center gap-3">
                                <svg class="w-6 h-6 text-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                </svg>
                                <span>Utility Consumption</span>
                                <div class="badge badge-warning badge-sm">Required</div>
                            </div>
                        </div>
                        <div class="collapse-content">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 pt-4">
                                <div class="form-control">
                                    <label class="label" for="{{ utility_form.kg_co2.id_for_label }}">
                                        <span class="label-text">CO2 Consumption</span>
                                        <span class="label-text-alt text-error">*</span>
                                    </label>
                                    <div class="join">
                                        {{ utility_form.kg_co2 }}
                                        <span class="btn btn-outline join-item">kg</span>
                                    </div>
                                    {% if utility_form.kg_co2.errors %}
                                        <label class="label">
                                            <span class="label-text-alt text-error">{{ utility_form.kg_co2.errors.0 }}</span>
                                        </label>
                                    {% endif %}
                                </div>

                                <div class="form-control">
                                    <label class="label" for="{{ utility_form.boiler_fuel_l.id_for_label }}">
                                        <span class="label-text">Boiler Fuel</span>
                                    </label>
                                    <div class="join">
                                        {{ utility_form.boiler_fuel_l }}
                                        <span class="btn btn-outline join-item">L</span>
                                    </div>
                                    {% if utility_form.boiler_fuel_l.errors %}
                                        <label class="label">
                                            <span class="label-text-alt text-error">{{ utility_form.boiler_fuel_l.errors.0 }}</span>
                                        </label>
                                    {% else %}
                                        <label class="label">
                                            <span class="label-text-alt">Optional - leave blank if not used</span>
                                        </label>
                                    {% endif %}
                                </div>

                                <div class="form-control">
                                    <label class="label" for="{{ utility_form.generator_fuel_l.id_for_label }}">
                                        <span class="label-text">Generator Fuel</span>
                                    </label>
                                    <div class="join">
                                        {{ utility_form.generator_fuel_l }}
                                        <span class="btn btn-outline join-item">L</span>
                                    </div>
                                    {% if utility_form.generator_fuel_l.errors %}
                                        <label class="label">
                                            <span class="label-text-alt text-error">{{ utility_form.generator_fuel_l.errors.0 }}</span>
                                        </label>
                                    {% else %}
                                        <label class="label">
                                            <span class="label-text-alt">Optional - leave blank if not used</span>
                                        </label>
                                    {% endif %}
                                </div>

                                <div class="form-control">
                                    <label class="label" for="{{ utility_form.edg_power_consumption.id_for_label }}">
                                        <span class="label-text">EDG Power Consumption</span>
                                    </label>
                                    <div class="join">
                                        {{ utility_form.edg_power_consumption }}
                                        <span class="btn btn-outline join-item">kWh</span>
                                    </div>
                                    {% if utility_form.edg_power_consumption.errors %}
                                        <label class="label">
                                            <span class="label-text-alt text-error">{{ utility_form.edg_power_consumption.errors.0 }}</span>
                                        </label>
                                    {% else %}
                                        <label class="label">
                                            <span class="label-text-alt">Optional - Emergency diesel generator power</span>
                                        </label>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                
                    <!-- Form Actions -->
                    <div class="card-actions justify-between pt-8 border-t border-base-300">
                        <a href="{% url 'manufacturing:production_run_detail' object.pk %}" class="btn btn-ghost btn-lg">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                            </svg>
                            Cancel
                        </a>
                        <div class="flex gap-3">
                            <button type="button" class="btn btn-outline btn-lg" onclick="document.querySelector('form').reset()">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                </svg>
                                Reset
                            </button>
                            <button type="submit" class="btn btn-primary btn-lg gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                </svg>
                                Update Production Run
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Production Status Alert -->
        {% if object.is_completed %}
        <div class="alert alert-success mt-6">
            <svg class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <span>This production run is completed. Changes may affect final reports.</span>
        </div>
        {% else %}
        <div class="alert alert-info mt-6">
            <svg class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <span>Production run is active. You can update details as needed.</span>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}
