{% extends 'layout.html' %}
{% load static %}
{% load humanize %}
{% block title %}OEE Trend Analysis{% endblock %}

{% block subtitle %}
<p class="text-lg md:text-xl text-base-content/70 max-w-3xl">
    Overall Equipment Effectiveness trending analysis
</p>
{% endblock %}

{% block breadcrumbs %}
<li><a href="{% url 'reports:dashboard' %}">Reports</a></li>
<li>OEE Trend</li>
{% endblock %}

{% block main_content %}
<div class="container mx-auto px-4 py-8">
    <div class="max-w-7xl mx-auto space-y-8">
        
        <!-- Header -->
        

        <!-- Filter Form -->
        <div class="card bg-base-100 shadow-xl">
            <div class="card-body">
                <h3 class="card-title mb-4">Analysis Period</h3>
                <form method="get" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-semibold">Start Date</span>
                        </label>
                        {{ form.start_date }}
                    </div>
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-semibold">End Date</span>
                        </label>
                        {{ form.end_date }}
                    </div>
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-semibold">Production Line</span>
                        </label>
                        <select 
                            name="{{ form.production_line.name }}" 
                            class="select select-bordered w-full"
                            hx-get="{% url 'reports:machines_by_line_htmx' %}"
                            hx-trigger="change"
                            hx-target="#oee-machine-select"
                            hx-include="this"
                        >
                            <option value="">All Production Lines</option>
                            {% for choice in form.production_line.field.queryset %}
                            <option value="{{ choice.id }}" {% if form.production_line.value == choice.id|stringformat:"s" %}selected{% endif %}>{{ choice.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-semibold">Machine</span>
                        </label>
                        <select id="oee-machine-select" name="{{ form.machine.name }}" class="select select-bordered w-full">
                            <option value="">All Machines</option>
                            {% for choice in form.machine.field.queryset %}
                            <option value="{{ choice.id }}" {% if form.machine.value == choice.id|stringformat:"s" %}selected{% endif %}>{{ choice.machine_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-control lg:col-span-4">
                        <button type="submit" class="btn btn-primary">Analyze OEE Trends</button>
                    </div>
                </form>
            </div>
        </div>

        {% if oee_data %}

        <!-- Report Header -->
        <div class="card bg-gradient-to-r from-indigo-500 to-indigo-600 text-white shadow-xl">
            <div class="card-body">
                <div class="flex items-center justify-center">
                    <div class="text-center">
                        <h2 class="text-3xl font-bold">OEE Analysis</h2>
                        <p class="text-lg opacity-90 mt-2">
                                {{ oee_data.period.start_date|date:"M d, Y" }} - {{ oee_data.period.end_date|date:"M d, Y" }}
                        </p>
                        <p class="text-sm opacity-75">{{ oee_data.period.production_line }}{% if oee_data.period.machine != 'All Machines' %} - {{ oee_data.period.machine }}{% endif %}</p>
                    </div>
                   
                </div>
            </div>
        </div>

        <!-- OEE Summary Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
            {% if oee_data.period_averages %}
                <!-- Period averages for the selected date range -->
                <div class="card bg-blue-50 border border-blue-200">
                    <div class="card-body text-center">
                        <div class="text-3xl font-bold text-blue-600">
                            {{ oee_data.period_averages.period_avg_oee|floatformat:1|default:"0" }}%
                        </div>
                        <div class="text-sm text-blue-800 font-semibold">Average OEE</div>
                        
                    </div>
                </div>
                <div class="card bg-green-50 border border-green-200">
                    <div class="card-body text-center">
                        <div class="text-3xl font-bold text-green-600">
                            {{ oee_data.period_averages.period_avg_availability|floatformat:1|default:"0" }}%
                        </div>
                        <div class="text-sm text-green-800 font-semibold">Avg Availability</div>
                    </div>
                </div>
                <div class="card bg-yellow-50 border border-yellow-200">
                    <div class="card-body text-center">
                        <div class="text-3xl font-bold text-yellow-600">
                            {{ oee_data.period_averages.period_avg_performance|floatformat:1|default:"0" }}%
                        </div>
                        <div class="text-sm text-yellow-800 font-semibold">Avg Performance</div>
                    </div>
                </div>
                <div class="card bg-red-50 border border-red-200">
                    <div class="card-body text-center">
                        <div class="text-3xl font-bold text-red-600">
                            {{ oee_data.period_averages.period_avg_quality|floatformat:1|default:"0" }}%
                        </div>
                        <div class="text-sm text-red-800 font-semibold">Avg Quality</div>
                    </div>
                </div>
            {% endif %}
        </div>

        <div class="grid grid-cols-1 xl:grid-cols-2 gap-8">
            <!-- OEE Trend Chart -->
            <div class="card bg-base-100 shadow-xl">
                <div class="card-body">
                    <h3 class="card-title text-xl mb-4">OEE Components Trend</h3>
                    <div class="h-96">
                        <canvas id="oeeChart"></canvas>
                    </div>
                </div>
            </div>
    
             <!-- Downtime Analysis -->
             {% if oee_data.downtime_analysis %}
             {% include 'reports/partials/pareto_chart.html' with pareto_data=oee_data.downtime_pareto_data chart_title="Downtime Analysis - Pareto Chart" chart_id="downtimePareto" %}
             {% endif %}
        </div>

        <!-- Daily OEE Performance Table -->
        <div class="card bg-base-100 shadow-xl">
            <div class="card-body">
                <h3 class="card-title text-xl mb-4">Daily OEE Performance</h3>
                <div class="overflow-x-auto">
                    <table class="table table-zebra w-full">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th class="text-center">OEE %</th>
                                <th class="text-center">Availability %</th>
                                <th class="text-center">Performance %</th>
                                <th class="text-center">Quality %</th>
                                <th class="text-center">Runs</th>
                                <th>Grade</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in oee_data.oee_trend %}
                            <tr>
                                <td class="font-semibold">{{ item.production_run__date|date:"M d, Y" }}</td>
                                <td class="text-center">
                                    <div class="flex items-center justify-center">
                                        <span class="font-bold {% if item.avg_oee >= 85 %}text-green-600{% elif item.avg_oee >= 70 %}text-blue-600{% elif item.avg_oee >= 50 %}text-yellow-600{% else %}text-red-600{% endif %}">
                                            {{ item.avg_oee|floatformat:1|default:"0" }}%
                                        </span>
                                    </div>
                                </td>
                                <td class="text-center font-mono">{{ item.avg_availability|floatformat:1|default:"0" }}%</td>
                                <td class="text-center font-mono">{{ item.avg_performance|floatformat:1|default:"0" }}%</td>
                                <td class="text-center font-mono">{{ item.avg_quality|floatformat:1|default:"0" }}%</td>
                                <td class="text-center">
                                    <span class="badge badge-outline">{{ item.runs_count }}</span>
                                </td>
                                <td>
                                    {% if item.avg_oee >= 85 %}
                                        <span class="badge badge-success">World Class</span>
                                    {% elif item.avg_oee >= 70 %}
                                        <span class="badge badge-info">Good</span>
                                    {% elif item.avg_oee >= 50 %}
                                        <span class="badge badge-warning">Fair</span>
                                    {% else %}
                                        <span class="badge badge-error">Poor</span>
                                    {% endif %}
                                </td>
                                
                                <td>
                                    <div class="dropdown dropdown-end">
                                        <div tabindex="0" role="button" class="btn btn-ghost btn-sm">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"></path>
                                            </svg>
                                        </div>
                                        <ul tabindex="0" class="dropdown-content z-[1] menu p-2 shadow bg-base-100 rounded-box w-52">
                                            <li>
                                                <a href="{% url 'manufacturing:production_run_detail' item.production_run__id %}">
                                                    
                                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                                        </svg>
                                                        <span class="pl-4">View Details</span>
                                                   
                                                </a>
                                            </li>
                                        </ul>
                                    </div>

                                    </div>
                                   
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>


        
        <!-- Detailed Downtime Table -->
        <div class="card bg-base-100 shadow-xl">
            <div class="card-body">
                <h3 class="card-title text-xl mb-4">Detailed Downtime Analysis</h3>
                <div class="overflow-x-auto">
                    <table class="table table-zebra w-full">
                        <thead>
                            <tr>
                                <th class="w-20">#</th>
                                <th>Machine</th>
                                <!-- <th>Code</th> -->
                                <th>Code Reason</th>
                                <th class="text-center">Total Duration</th>
                                <th class="text-center">#Occurrences</th>
                                <th class="text-center">Avg Duration</th>
                                <th class="text-center">% of Total</th>
                                <th>Impact</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in oee_data.downtime_analysis %}
                            <tr>
                                <td class="font-bold text-lg">{{ forloop.counter }}</td>
                                <td>
                                    <div class="max-w-xs">
                                        <div class="font-semibold">{{ item.machine__machine_name|default:"No description provided" }}</div>
                                    </div>
                                </td>
                                <!-- <td>
                                    <span class="badge badge-outline font-mono">{{ item.code__code }}</span>
                                </td> -->
                                <td>
                                    <div class="max-w-xs flex flex-col gap-1">
                                        <div class="font-semibold">{{ item.code__reason|default:"No description provided" }}</div>
                                        <div class="badge badge-outline font-mono text-gray-500">{{ item.code__code }}</span>
                                    </div>
                                </td>
                               
                                <td class="text-center">
                                    <div class="font-bold text-lg {% if item.total_duration > 120 %}text-red-600{% elif item.total_duration > 60 %}text-orange-600{% else %}text-green-600{% endif %}">
                                        {{ item.total_duration|floatformat:0|intcomma }}
                                    </div>
                                    <div class="text-xs text-gray-500">minutes</div>
                                </td>
                                <td class="text-center">
                                    <div class="font-bold text-lg text-blue-600">{{ item.occurrence_count }}</div>
                                    <div class="text-xs text-gray-500">times</div>
                                </td>
                                <td class="text-center">
                                    <div class="font-semibold">
                                        {{ item.avg_duration|floatformat:1 }}
                                    </div>
                                    <div class="text-xs text-gray-500">min/occurrence</div>
                                </td>
                                <td class="text-center">
                                    <div class="font-semibold">
                                        {{ item.percentage_of_total|default:"0" }}%
                                    </div>
                                </td>
                                <td>
                                    {% if item.total_duration > 240 %}
                                        <span class="badge badge-error">Critical</span>
                                    {% elif item.total_duration > 120 %}
                                        <span class="badge badge-warning">High</span>
                                    {% elif item.total_duration > 60 %}
                                        <span class="badge badge-info">Medium</span>
                                    {% else %}
                                        <span class="badge badge-success">Low</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        {% else %}
        <!-- No Data State -->
        <div class="card bg-base-100 shadow-xl">
            <div class="card-body text-center justify-center items-center py-16">
                <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mb-3">
                    <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path>
                    </svg>
                </div>
                <h3 class="text-2xl font-bold mb-2">No OEE Data Available</h3>
                <p class="text-gray-600 mb-6">Please select a date range and optionally a production line and machine to analyze OEE trends.</p>
                <div class="flex flex-wrap justify-center gap-2">
                    <span class="badge badge-outline">Select start date</span>
                    <span class="badge badge-outline">Select end date</span>
                    <span class="badge badge-outline">Choose production line (optional)</span>
                    <span class="badge badge-outline">Choose machine (optional)</span>
                </div>
            </div>
        </div>
        {% endif %}

    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// OEE Trend Chart
{% if oee_data %}
// Custom plugin to display data labels without external dependency
const dataLabelsPlugin = {
    id: 'dataLabels',
    afterDatasetsDraw: function(chart, args, options) {
        const ctx = chart.ctx;
        chart.data.datasets.forEach((dataset, datasetIndex) => {
            if (dataset.label === 'OEE %') { // Only show labels for OEE dataset
                const meta = chart.getDatasetMeta(datasetIndex);
                meta.data.forEach((point, index) => {
                    const value = dataset.data[index];
                    if (value !== null && value !== undefined) {
                        ctx.save();
                        ctx.font = 'bold 11px Arial';
                        ctx.fillStyle = dataset.borderColor;
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'bottom';
                        
                        const text = value + '%';
                        const x = point.x;
                        const y = point.y - 8; // Position above the point
                        
                        // Add background for better visibility
                        const textWidth = ctx.measureText(text).width;
                        ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
                        ctx.fillRect(x - textWidth/2 - 2, y - 12, textWidth + 4, 14);
                        
                        // Draw the text
                        ctx.fillStyle = dataset.borderColor;
                        ctx.fillText(text, x, y);
                        ctx.restore();
                    }
                });
            }
        });
    }
};

const ctx = document.getElementById('oeeChart').getContext('2d');
const oeeChart = new Chart(ctx, {
    type: 'line',
    data: {
        labels: [
            {% for item in oee_data.oee_trend %}
                '{{ item.production_run__date|date:"M d" }}'{% if not forloop.last %},{% endif %}
            {% endfor %}
        ],
        datasets: [
            {
                label: 'OEE %',
                data: [
                    {% for item in oee_data.oee_trend %}
                        {{ item.avg_oee|floatformat:1|default:"0" }}{% if not forloop.last %},{% endif %}
                    {% endfor %}
                ],
                borderColor: 'rgb(59, 130, 246)',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                tension: 0.1,
                fill: true,
                borderWidth: 3
            },
            {
                label: 'Availability %',
                data: [
                    {% for item in oee_data.oee_trend %}
                        {{ item.avg_availability|floatformat:1|default:"0" }}{% if not forloop.last %},{% endif %}
                    {% endfor %}
                ],
                borderColor: 'rgb(16, 185, 129)',
                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                tension: 0.1,
                borderWidth: 2,
                borderDash: [5, 5]
            },
            {
                label: 'Performance %',
                data: [
                    {% for item in oee_data.oee_trend %}
                        {{ item.avg_performance|floatformat:1|default:"0" }}{% if not forloop.last %},{% endif %}
                    {% endfor %}
                ],
                borderColor: 'rgb(245, 158, 11)',
                backgroundColor: 'rgba(245, 158, 11, 0.1)',
                tension: 0.1,
                borderWidth: 2,
                borderDash: [10, 5]
            },
            {
                label: 'Quality %',
                data: [
                    {% for item in oee_data.oee_trend %}
                        {{ item.avg_quality|floatformat:1|default:"0" }}{% if not forloop.last %},{% endif %}
                    {% endfor %}
                ],
                borderColor: 'rgb(239, 68, 68)',
                backgroundColor: 'rgba(239, 68, 68, 0.1)',
                tension: 0.1,
                borderWidth: 2,
                borderDash: [2, 2]
            }
        ]
    },
    plugins: [dataLabelsPlugin],
    options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: {
            mode: 'index',
            intersect: false,
        },
        scales: {
            y: {
                beginAtZero: true,
                max: 100,
                ticks: {
                    callback: function(value) {
                        return value + '%';
                    }
                },
                title: {
                    display: true,
                    text: 'Percentage (%)'
                }
            },
            x: {
                title: {
                    display: true,
                    text: 'Date'
                }
            }
        },
        plugins: {
            title: {
                display: true,
                text: 'OEE Components Trend Analysis'
            },
            legend: {
                position: 'top'
            },
            tooltip: {
                mode: 'index',
                intersect: false,
                callbacks: {
                    label: function(context) {
                        return context.dataset.label + ': ' + context.parsed.y.toFixed(1) + '%';
                    }
                }
            }
        }
    }
});
{% endif %}
</script>
{% endblock %}
