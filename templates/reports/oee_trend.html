{% extends 'layout.html' %}
{% load static %}

{% block title %}OEE Trend Analysis{% endblock %}

{% block subtitle %}
<p class="text-lg md:text-xl text-base-content/70 max-w-3xl">
    Overall Equipment Effectiveness trending analysis
</p>
{% endblock %}

{% block breadcrumbs %}
<li><a href="{% url 'reports:dashboard' %}">Reports</a></li>
<li>OEE Trend</li>
{% endblock %}

{% block main_content %}
<div class="container mx-auto px-4 py-8">
    <div class="max-w-7xl mx-auto">
        
        <!-- Header -->
        

        <!-- Filter Form -->
        <div class="card bg-base-100 shadow-xl mb-8">
            <div class="card-body">
                <h3 class="card-title mb-4">Analysis Period</h3>
                <form method="get" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-semibold">Start Date</span>
                        </label>
                        {{ form.start_date }}
                    </div>
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-semibold">End Date</span>
                        </label>
                        {{ form.end_date }}
                    </div>
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-semibold">Production Line</span>
                        </label>
                        <select 
                            name="{{ form.production_line.name }}" 
                            class="select select-bordered w-full"
                            hx-get="{% url 'reports:machines_by_line_htmx' %}"
                            hx-trigger="change"
                            hx-target="#oee-machine-select"
                            hx-include="this"
                        >
                            <option value="">All Production Lines</option>
                            {% for choice in form.production_line.field.queryset %}
                            <option value="{{ choice.id }}" {% if form.production_line.value == choice.id|stringformat:"s" %}selected{% endif %}>{{ choice.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-semibold">Machine</span>
                        </label>
                        <select id="oee-machine-select" name="{{ form.machine.name }}" class="select select-bordered w-full">
                            <option value="">All Machines</option>
                            {% for choice in form.machine.field.queryset %}
                            <option value="{{ choice.id }}" {% if form.machine.value == choice.id|stringformat:"s" %}selected{% endif %}>{{ choice.machine_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-control lg:col-span-4">
                        <button type="submit" class="btn btn-primary">Analyze OEE Trends</button>
                    </div>
                </form>
            </div>
        </div>

        {% if trend_data %}
        <!-- OEE Summary Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            {% with trend_data as data %}
            {% for item in data %}
                {% if forloop.first %}
                    <!-- Calculate averages for the period -->
                    <div class="card bg-blue-50 border border-blue-200">
                        <div class="card-body text-center">
                            <div class="text-3xl font-bold text-blue-600">
                                {% widthratio data|length 1 data|length as avg_oee %}
                                {{ data.0.avg_oee|floatformat:1|default:"0" }}%
                            </div>
                            <div class="text-sm text-blue-800 font-semibold">Average OEE</div>
                            <div class="text-xs text-blue-600 mt-1">{{ start_date|date:"M d" }} - {{ end_date|date:"M d" }}</div>
                        </div>
                    </div>
                    <div class="card bg-green-50 border border-green-200">
                        <div class="card-body text-center">
                            <div class="text-3xl font-bold text-green-600">
                                {{ data.0.avg_availability|floatformat:1|default:"0" }}%
                            </div>
                            <div class="text-sm text-green-800 font-semibold">Avg Availability</div>
                        </div>
                    </div>
                    <div class="card bg-yellow-50 border border-yellow-200">
                        <div class="card-body text-center">
                            <div class="text-3xl font-bold text-yellow-600">
                                {{ data.0.avg_performance|floatformat:1|default:"0" }}%
                            </div>
                            <div class="text-sm text-yellow-800 font-semibold">Avg Performance</div>
                        </div>
                    </div>
                    <div class="card bg-red-50 border border-red-200">
                        <div class="card-body text-center">
                            <div class="text-3xl font-bold text-red-600">
                                {{ data.0.avg_quality|floatformat:1|default:"0" }}%
                            </div>
                            <div class="text-sm text-red-800 font-semibold">Avg Quality</div>
                        </div>
                    </div>
                {% endif %}
            {% endfor %}
            {% endwith %}
        </div>

        <!-- OEE Trend Chart -->
        <div class="card bg-base-100 shadow-xl mb-8">
            <div class="card-body">
                <h3 class="card-title text-xl mb-4">OEE Components Trend</h3>
                <div class="h-96">
                    <canvas id="oeeChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Daily OEE Performance Table -->
        <div class="card bg-base-100 shadow-xl">
            <div class="card-body">
                <h3 class="card-title text-xl mb-4">Daily OEE Performance</h3>
                <div class="overflow-x-auto">
                    <table class="table table-zebra w-full">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th class="text-center">OEE %</th>
                                <th class="text-center">Availability %</th>
                                <th class="text-center">Performance %</th>
                                <th class="text-center">Quality %</th>
                                <th class="text-center">Runs</th>
                                <th>Grade</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in trend_data %}
                            <tr>
                                <td class="font-semibold">{{ item.production_run__date|date:"M d, Y" }}</td>
                                <td class="text-center">
                                    <div class="flex items-center justify-center">
                                        <span class="font-bold {% if item.avg_oee >= 85 %}text-green-600{% elif item.avg_oee >= 70 %}text-blue-600{% elif item.avg_oee >= 50 %}text-yellow-600{% else %}text-red-600{% endif %}">
                                            {{ item.avg_oee|floatformat:1|default:"0" }}%
                                        </span>
                                    </div>
                                </td>
                                <td class="text-center font-mono">{{ item.avg_availability|floatformat:1|default:"0" }}%</td>
                                <td class="text-center font-mono">{{ item.avg_performance|floatformat:1|default:"0" }}%</td>
                                <td class="text-center font-mono">{{ item.avg_quality|floatformat:1|default:"0" }}%</td>
                                <td class="text-center">
                                    <span class="badge badge-outline">{{ item.runs_count }}</span>
                                </td>
                                <td>
                                    {% if item.avg_oee >= 85 %}
                                        <span class="badge badge-success">World Class</span>
                                    {% elif item.avg_oee >= 70 %}
                                        <span class="badge badge-info">Good</span>
                                    {% elif item.avg_oee >= 50 %}
                                        <span class="badge badge-warning">Fair</span>
                                    {% else %}
                                        <span class="badge badge-error">Poor</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        {% else %}
        <!-- No Data State -->
        <div class="card bg-base-100 shadow-xl">
            <div class="card-body text-center py-16">
                <div class="text-6xl mb-4">ðŸ“ˆ</div>
                <h3 class="text-2xl font-bold mb-2">No OEE Data Available</h3>
                <p class="text-gray-600 mb-6">Please select a date range and optionally a production line and machine to analyze OEE trends.</p>
                <div class="flex flex-wrap justify-center gap-2">
                    <span class="badge badge-outline">Select start date</span>
                    <span class="badge badge-outline">Select end date</span>
                    <span class="badge badge-outline">Choose production line (optional)</span>
                    <span class="badge badge-outline">Choose machine (optional)</span>
                </div>
            </div>
        </div>
        {% endif %}

    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// OEE Trend Chart
{% if trend_data %}
const ctx = document.getElementById('oeeChart').getContext('2d');
const oeeChart = new Chart(ctx, {
    type: 'line',
    data: {
        labels: [
            {% for item in trend_data %}
                '{{ item.production_run__date|date:"M d" }}'{% if not forloop.last %},{% endif %}
            {% endfor %}
        ],
        datasets: [
            {
                label: 'OEE %',
                data: [
                    {% for item in trend_data %}
                        {{ item.avg_oee|floatformat:1|default:"0" }}{% if not forloop.last %},{% endif %}
                    {% endfor %}
                ],
                borderColor: 'rgb(59, 130, 246)',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                tension: 0.1,
                fill: true,
                borderWidth: 3
            },
            {
                label: 'Availability %',
                data: [
                    {% for item in trend_data %}
                        {{ item.avg_availability|floatformat:1|default:"0" }}{% if not forloop.last %},{% endif %}
                    {% endfor %}
                ],
                borderColor: 'rgb(16, 185, 129)',
                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                tension: 0.1,
                borderWidth: 2,
                borderDash: [5, 5]
            },
            {
                label: 'Performance %',
                data: [
                    {% for item in trend_data %}
                        {{ item.avg_performance|floatformat:1|default:"0" }}{% if not forloop.last %},{% endif %}
                    {% endfor %}
                ],
                borderColor: 'rgb(245, 158, 11)',
                backgroundColor: 'rgba(245, 158, 11, 0.1)',
                tension: 0.1,
                borderWidth: 2,
                borderDash: [10, 5]
            },
            {
                label: 'Quality %',
                data: [
                    {% for item in trend_data %}
                        {{ item.avg_quality|floatformat:1|default:"0" }}{% if not forloop.last %},{% endif %}
                    {% endfor %}
                ],
                borderColor: 'rgb(239, 68, 68)',
                backgroundColor: 'rgba(239, 68, 68, 0.1)',
                tension: 0.1,
                borderWidth: 2,
                borderDash: [2, 2]
            }
        ]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: {
            mode: 'index',
            intersect: false,
        },
        scales: {
            y: {
                beginAtZero: true,
                max: 100,
                ticks: {
                    callback: function(value) {
                        return value + '%';
                    }
                },
                title: {
                    display: true,
                    text: 'Percentage (%)'
                }
            },
            x: {
                title: {
                    display: true,
                    text: 'Date'
                }
            }
        },
        plugins: {
            title: {
                display: true,
                text: 'OEE Components Trend Analysis'
            },
            legend: {
                position: 'top'
            },
            tooltip: {
                mode: 'index',
                intersect: false,
                callbacks: {
                    label: function(context) {
                        return context.dataset.label + ': ' + context.parsed.y.toFixed(1) + '%';
                    }
                }
            }
        }
    }
});
{% endif %}
</script>
{% endblock %}
