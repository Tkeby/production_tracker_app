{% load static %}

<div class="card bg-base-100 shadow-xl">
    <div class="card-body">
        <div class="flex items-center justify-between mb-4">
            <h3 class="card-title text-xl">{{ chart_title|default:"Pareto Analysis" }}</h3>
            <div class="tooltip" data-tip="Pareto chart shows the 80/20 rule - highlighting the few causes that contribute to most of the problems">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-info shrink-0 w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
            </div>
        </div>
        
        {% if pareto_data.categories %}
        <div class="h-96">
            <canvas id="{{ chart_id|default:'paretoChart' }}"></canvas>
        </div>
        
        <!-- Pareto Insights -->
        <!-- <div class="mt-4 p-4 bg-blue-50 rounded-lg">
            <div class="flex items-center gap-2 mb-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <span class="font-semibold text-blue-800">Pareto Insights</span>
            </div>
            <div class="text-sm text-blue-700">
                {% if pareto_data.pareto_80_index is not None %}
                <p><strong>80% Rule:</strong> The first {{ pareto_data.pareto_80_index|add:1 }} causes account for 80% of total downtime.</p>
                <p class="mt-1"><strong>Focus Area:</strong> Addressing these top causes will have the maximum impact on reducing downtime.</p>
                {% else %}
                <p><strong>Focus Area:</strong> The top causes shown represent the highest impact areas for downtime reduction.</p>
                {% endif %}
            </div>
        </div> -->
        
        <script>
        // Pareto Chart for {{ chart_id|default:'paretoChart' }}
        function create{{ chart_id|default:'paretoChart'|title }}() {
            try {
                // Check if Chart.js is available
                if (typeof Chart === 'undefined') {
                    console.log('Chart.js not yet loaded, retrying...');
                    setTimeout(create{{ chart_id|default:'paretoChart'|title }}, 100);
                    return;
                }
                
                const canvas = document.getElementById('{{ chart_id|default:"paretoChart" }}');
                if (!canvas) {
                    console.error('Canvas element not found: {{ chart_id|default:"paretoChart" }}');
                    return;
                }
                
                const ctx = canvas.getContext('2d');
                
                // Prepare color arrays
                const barColors = [];
                const borderColors = [];
                const dataLength = {{ pareto_data.values|length }};
                
                for (let i = 0; i < dataLength; i++) {
                    {% if pareto_data.pareto_80_index is not None %}
                    if (i <= {{ pareto_data.pareto_80_index }}) {
                        barColors.push('rgba(239, 68, 68, 0.8)');
                        borderColors.push('rgb(239, 68, 68)');
                    } else {
                        barColors.push('rgba(156, 163, 175, 0.8)');
                        borderColors.push('rgb(156, 163, 175)');
                    }
                    {% else %}
                    barColors.push('rgba(239, 68, 68, 0.8)');
                    borderColors.push('rgb(239, 68, 68)');
                    {% endif %}
                }
                
                const paretoChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: [
                            {% for category in pareto_data.categories %}
                                '{{ category|truncatechars:25|escapejs }}'{% if not forloop.last %},{% endif %}
                            {% endfor %}
                        ],
                        datasets: [
                            {
                                label: 'Duration (minutes)',
                                data: [
                                    {% for value in pareto_data.values %}
                                        {{ value }}{% if not forloop.last %},{% endif %}
                                    {% endfor %}
                                ],
                                backgroundColor: barColors,
                                borderColor: borderColors,
                                borderWidth: 2,
                                yAxisID: 'y'
                            },
                            {
                                label: 'Cumulative %',
                                data: [
                                    {% for percentage in pareto_data.cumulative_percentages %}
                                        {{ percentage }}{% if not forloop.last %},{% endif %}
                                    {% endfor %}
                                ],
                                type: 'line',
                                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                borderColor: 'rgb(59, 130, 246)',
                                borderWidth: 3,
                                fill: false,
                                tension: 0.1,
                                yAxisID: 'y1',
                                pointBackgroundColor: 'rgb(59, 130, 246)',
                                pointBorderColor: 'rgb(59, 130, 246)',
                                pointRadius: 4,
                                pointHoverRadius: 6
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false,
                        },
                        plugins: {
                            title: {
                                display: true,
                                text: 'Pareto Analysis - Downtime Causes',
                                font: {
                                    size: 16
                                }
                            },
                            legend: {
                                position: 'top',
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        if (context.dataset.label === 'Duration (minutes)') {
                                            return context.dataset.label + ': ' + context.parsed.y + ' minutes';
                                        } else {
                                            return context.dataset.label + ': ' + context.parsed.y + '%';
                                        }
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: 'Downtime Causes (by Impact)'
                                },
                                ticks: {
                                    maxRotation: 45,
                                    minRotation: 45
                                }
                            },
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                title: {
                                    display: true,
                                    text: 'Duration (Minutes)'
                                },
                                ticks: {
                                    beginAtZero: true
                                }
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                title: {
                                    display: true,
                                    text: 'Cumulative Percentage (%)'
                                },
                                min: 0,
                                max: 100,
                                grid: {
                                    drawOnChartArea: false,
                                },
                                ticks: {
                                    callback: function(value) {
                                        return value + '%';
                                    }
                                }
                            }
                        }
                    }
                });
                
                console.log('Pareto chart created successfully for {{ chart_id|default:"paretoChart" }}');
                
            } catch (error) {
                console.error('Error creating Pareto chart:', error);
                
                // Show error message in the chart area
                const canvas = document.getElementById('{{ chart_id|default:"paretoChart" }}');
                if (canvas) {
                    const parent = canvas.parentElement;
                    parent.innerHTML = '<div class="flex items-center justify-center h-full text-red-500"><div class="text-center"><div class="text-4xl mb-2">‚ö†Ô∏è</div><p>Error loading chart</p><p class="text-sm">Check browser console for details</p></div></div>';
                }
            }
        }
        
        // Start chart creation when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', create{{ chart_id|default:'paretoChart'|title }});
        } else {
            create{{ chart_id|default:'paretoChart'|title }}();
        }
        </script>
        
        {% else %}
        <div class="text-center text-gray-500 py-16">
            <div class="text-4xl mb-2">üìä</div>
            <p>No data available for Pareto analysis</p>
        </div>
        {% endif %}
    </div>
</div>
